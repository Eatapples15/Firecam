<!DOCTYPE html>
<html lang="it">
<head>
    </head>
<body>
    <h1>Webcam in Basilicata</h1>
    <div id="map"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <script>
        let map;
        let markers = [];

        async function initMap() {
            const basilicataCenter = { lat: 40.4000, lng: 15.9000 };

            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 9,
                center: basilicataCenter,
                mapTypeId: google.maps.MapTypeId.ROADMAP
            });

            await fetchWebcamData();
        }

        async function fetchWebcamData() {
            const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTdQqAKe4k4goB9Q7ijesTG-JCE4uw-8UXX4HyHwuH9aeKsyxKHoklMLMfIE_yPL_hvG72s8mIUpeCP/pub?output=csv';

            try {
                PapaParse.parse(csvUrl, {
                    download: true,
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        if (results.errors.length > 0) {
                            console.error("Errori nel parsing CSV:", results.errors);
                        }

                        results.data.forEach(row => {
                            const id = row["Id"];
                            const citta = row["Città"];
                            const provincia = row["Provincia"];
                            const coordinateStr = row["coordinate"];
                            const link = row["Link"];
                            const stato = row["Stato"];
                            const note = row["Note"];

                            if (coordinateStr && link && citta && provincia) {
                                const [lat, lng] = coordinateStr.split(',').map(Number);
                                if (!isNaN(lat) && !isNaN(lng)) {
                                    addMarker({
                                        idCittaProvincia: `${citta} (${provincia})`,
                                        lat,
                                        lng,
                                        link,
                                        stato: stato || 'Sconosciuto',
                                        note: note || 'Nessuna nota'
                                    });
                                } else {
                                    console.warn(`Coordinate non valide per la riga (salto marker):`, row);
                                }
                            } else {
                                // Questa è la riga "vuota" o incompleta che causa l'avviso
                                // Se `id` è vuoto o null, è probabilmente una riga che non dovrebbe essere processata
                                if (id === "" || id === null || id === undefined) {
                                    // Ignora silenziosamente le righe prive di ID (probabilmente l'ultima riga del tuo CSV)
                                    // console.warn(`Riga incompleta o senza ID (ignorata):`, row); // Puoi riattivare questo per debug
                                } else {
                                    console.warn(`Dati essenziali (coordinate, link, città o provincia) mancanti per la riga (salto marker):`, row);
                                }
                            }
                        });
                    }
                });
            } catch (error) {
                console.error("Errore nel recupero o inizializzazione del parsing CSV:", error);
                alert("Si è verificato un errore durante il caricamento dei dati delle webcam. Controlla la console per i dettagli.");
            }
        }

        function addMarker(webcam) {
            const marker = new google.maps.Marker({
                position: { lat: webcam.lat, lng: webcam.lng },
                map: map,
                title: webcam.idCittaProvincia,
            });

            const infoWindowContent = `
                <h3>${webcam.idCittaProvincia}</h3>
                <p>Stato: <strong>${webcam.stato}</strong></p>
                ${webcam.note ? `<p>Note: ${webcam.note}</p>` : ''}
                <p><a href="${webcam.link}" target="_blank">Vedi Webcam Esterna</a></p>
                <button onclick="addWebcamToMosaic('${encodeURIComponent(webcam.idCittaProvincia)}', '${encodeURIComponent(webcam.link)}')">Aggiungi a Mosaico</button>
            `;

            const infoWindow = new google.maps.InfoWindow({
                content: infoWindowContent
            });

            marker.addListener("click", () => {
                infoWindow.open(map, marker);
            });

            markers.push(marker);
        }

        function addWebcamToMosaic(idCittaProvincia, link) {
            window.open(`mosaico.html?webcam=${idCittaProvincia}&link=${link}`, '_blank');
        }
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAPopf5IhIsRjpZ8QS-W1atKwJ8OTvxscY=initMap"></script>
</body>
</html>
